<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mountain Bike 3D</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family: Arial, sans-serif; }
  .menu, .selection { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:12px; padding:2rem; box-shadow:0 4px 20px rgba(0,0,0,0.5); max-width:90vw; width:400px; text-align:center; }
  button { padding:0.75rem 1.5rem; margin:0.5rem; font-size:1rem; border-radius:8px; border:none; cursor:pointer; }
  button:hover { opacity:0.9; }
  canvas { display:block; margin:0 auto; border:4px solid #444; background:linear-gradient(to top, #4a9c2f, #87ceeb);}
  .stats { text-align:left; font-size:0.9rem; margin-top:0.5rem; }
  .trail-difficulty { font-weight:bold; color:white; padding:0.2rem 0.4rem; border-radius:4px; }
  .back-btn { background:#888; color:white; }
</style>
</head>
<body>

<!-- Start Screen -->
<div id="menu" class="menu">
  <h1>Mountain Bike 3D</h1>
  <p>Ride the mountain trails in first person!</p>
  <button id="startBtn">Start Game</button>
</div>

<!-- Bike Selection -->
<div id="bikeSelect" class="selection" style="display:none;">
  <h2>Select Your Bike</h2>
  <div id="bikeList"></div>
  <button class="back-btn" onclick="goBack('menu')">Back</button>
</div>

<!-- Map Selection -->
<div id="mapSelect" class="selection" style="display:none;">
  <h2>Select a Mountain</h2>
  <div id="mapList"></div>
  <button class="back-btn" onclick="goBack('bikeSelect')">Back</button>
</div>

<!-- Trail Selection -->
<div id="trailSelect" class="selection" style="display:none;">
  <h2>Select a Trail</h2>
  <div id="trailList"></div>
  <button class="back-btn" onclick="goBack('mapSelect')">Back</button>
</div>

<!-- Gameplay Canvas -->
<canvas id="gameCanvas" width="1024" height="576" style="display:none;"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let screen = 'menu';
let selectedBike = null;
let selectedMap = null;
let selectedTrail = null;
let game = {};
let keys = {};
let animationRef;
let gameTime = 0;

const bikes = [
  {id:'mountain1', name:'Trail Blazer', color:'#ff0000', speed:3, handling:3, jump:2},
  {id:'mountain2', name:'Rock Rider', color:'#00ff00', speed:2, handling:4, jump:3},
  {id:'mountain3', name:'Peak Crusher', color:'#0000ff', speed:4, handling:2, jump:3},
];

const maps = [
  {id:'greenhill', name:'Green Hill', groundColor:'#3a9a2e', skyColor:'#87ceeb', trails:[]},
  {id:'bluevalley', name:'Blue Valley', groundColor:'#4a7fa8', skyColor:'#a0cfff', trails:[]},
  {id:'blackmount', name:'Black Mountain', groundColor:'#555555', skyColor:'#777777', trails:[]},
];

// Generate 6 trails per map: 2 easy, 2 medium, 2 hard
maps.forEach(map => {
  map.trails = [
    {id:'1', name:'Easy Loop 1', length:800, features:5, difficulty:'green'},
    {id:'2', name:'Easy Loop 2', length:850, features:6, difficulty:'green'},
    {id:'3', name:'Medium Pass 1', length:1200, features:10, difficulty:'blue'},
    {id:'4', name:'Medium Pass 2', length:1250, features:9, difficulty:'blue'},
    {id:'5', name:'Hard Peak 1', length:1500, features:15, difficulty:'black'},
    {id:'6', name:'Hard Peak 2', length:1550, features:16, difficulty:'black'},
  ];
});

// Navigation
function goBack(target){
  document.getElementById('menu').style.display='none';
  document.getElementById('bikeSelect').style.display='none';
  document.getElementById('mapSelect').style.display='none';
  document.getElementById('trailSelect').style.display='none';
  document.getElementById('gameCanvas').style.display='none';
  if(target==='menu') document.getElementById('menu').style.display='block';
  if(target==='bikeSelect') document.getElementById('bikeSelect').style.display='block';
  if(target==='mapSelect') document.getElementById('mapSelect').style.display='block';
  if(target==='trailSelect') document.getElementById('trailSelect').style.display='block';
}

// Populate bikes
const bikeList = document.getElementById('bikeList');
bikes.forEach(bike=>{
  const btn = document.createElement('button');
  btn.style.display='block';
  btn.style.margin='0.5rem auto';
  btn.innerHTML=`<strong>${bike.name}</strong>
  <div class="stats">Speed: ${'⭐'.repeat(bike.speed)}<br>Handling: ${'⭐'.repeat(bike.handling)}<br>Jump: ${'⭐'.repeat(bike.jump)}</div>`;
  btn.onclick = ()=>{
    selectedBike = bike;
    showScreen('mapSelect');
  };
  bikeList.appendChild(btn);
});

// Populate maps
const mapList = document.getElementById('mapList');
maps.forEach(map=>{
  const btn = document.createElement('button');
  btn.style.display='block';
  btn.style.margin='0.5rem auto';
  btn.innerHTML=map.name;
  btn.onclick = ()=>{
    selectedMap = map;
    showScreen('trailSelect');
  };
  mapList.appendChild(btn);
});

// Populate trails
const trailList = document.getElementById('trailList');
function populateTrails(){
  trailList.innerHTML='';
  selectedMap.trails.forEach(trail=>{
    const btn = document.createElement('button');
    btn.style.display='block';
    btn.style.margin='0.5rem auto';
    let color='';
    if(trail.difficulty==='green') color='green';
    if(trail.difficulty==='blue') color='blue';
    if(trail.difficulty==='black') color='black';
    btn.innerHTML=`${trail.name} <span class="trail-difficulty" style="background:${color}">${trail.difficulty}</span>`;
    btn.onclick=()=>{
      selectedTrail = trail;
      startGame();
    };
    trailList.appendChild(btn);
  });
}

// Show screen
function showScreen(target){
  document.getElementById('menu').style.display='none';
  document.getElementById('bikeSelect').style.display='none';
  document.getElementById('mapSelect').style.display='none';
  document.getElementById('trailSelect').style.display='none';
  document.getElementById('gameCanvas').style.display='none';
  if(target==='menu') document.getElementById('menu').style.display='block';
  if(target==='bikeSelect') document.getElementById('bikeSelect').style.display='block';
  if(target==='mapSelect') document.getElementById('mapSelect').style.display='block';
  if(target==='trailSelect') { document.getElementById('trailSelect').style.display='block'; populateTrails(); }
  if(target==='game') document.getElementById('gameCanvas').style.display='block';
}

document.getElementById('startBtn').onclick=()=>showScreen('bikeSelect');

// Key handling
window.addEventListener('keydown', e=>keys[e.key]=true);
window.addEventListener('keyup', e=>keys[e.key]=false);

// Helper
function shadeColor(color, percent){
  const f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent;
  const R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
  const r=Math.round((t-R)*p)+R;
  const g=Math.round((t-G)*p)+G;
  const b=Math.round((t-B)*p)+B;
  return `rgb(${r},${g},${b})`;
}

// Generate trail terrain and objects
function generateTrail(){
  const trailLength = selectedTrail.length;
  game.terrain=[];
  game.objects=[];
  game.mountainSides=[];
  game.trees=[];

  for(let z=0; z<=trailLength; z+=10){
    const height = 50 + Math.sin(z*0.01)*20 + Math.random()*10;
    const width = 200 + Math.random()*20;
    game.terrain.push({z,height,width,centerX:0,leftEdge:-width/2,rightEdge:width/2});
    // Add objects
    if(Math.random()<0.05){
      game.objects.push({x:(Math.random()-0.5)*50,y:height,z,objType:'rock',radius:5,color:'#555'});
    }
    if(Math.random()<0.03){
      game.objects.push({x:(Math.random()-0.5)*50,y:height,z,objType:'log',width:10,length:30,color:'#774411'});
    }
    // Trees/bushes
    if(Math.random()<0.02) game.trees.push({x:(Math.random()-0.5)*80,y:height,z,height:20,radius:5,isBush:false});
    if(Math.random()<0.02) game.trees.push({x:(Math.random()-0.5)*80,y:height,z,height:5,radius:5,isBush:true});
  }

  // Finish line
  game.objects.push({x:0,y:50,z:trailLength,objType:'finish',width:8,height:8,depth:2,color:'#FFF'});

  // Player
  game.player = {x:0,y:52,z:0,vx:0,vy:0,vz:5,rotY:0,rotVel:0,onGround:true,distance:0};
  game.crashed=false;
  game.finished=false;
  game.speed=0;
  game.time=0;
}

// 3D projection
function project3D(x,y,z){
  const scale = 300/(z-game.player.z+50);
  const px = canvas.width/2 + x*scale;
  const py = canvas.height/2 - y*scale;
  return {x:px,y:py,depth:z-game.player.z,scale};
}

// Draw cylinder for trees/bushes
function drawCylinder(x,y,z,radius,height,color){
  const p = project3D(x,y,z);
  const pTop = project3D(x,y+height,z);
  if(!p||!pTop) return;
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.ellipse(p.x,p.y,radius*p.scale,(p.y-pTop.y),0,0,Math.PI*2);
  ctx.fill();
}

// Draw box for logs, jumps, finish
function drawBox(x,y,z,w,h,d,color){
  const p = project3D(x,y,z);
  const pTop = project3D(x,y+h,z+d);
  if(!p||!pTop) return;
  ctx.fillStyle=color;
  ctx.fillRect(p.x-w*p.scale/2,p.y-h*p.scale,p.scale*w,p.scale*h);
}

// Game loop
function startGame(){
  showScreen('game');
  generateTrail();
  function loop(){
    if(game.crashed || game.finished){
      if(keys['r'] || keys['R']){
        generateTrail();
      }
    }
    game.time+=0.016;
    // Controls
    const turnSpeed=0.03,jumpPower=12;
    if(keys['a']||keys['A']||keys['ArrowLeft']){game.player.rotVel+=turnSpeed;game.player.vx+=0.08;}
    if(keys['d']||keys['D']||keys['ArrowRight']){game.player.rotVel-=turnSpeed;game.player.vx-=0.08;}
    if(keys[' '] && game.player.onGround){game.player.vy=jumpPower;game.player.onGround=false;}

    // Physics
    game.player.vz=Math.max(3,Math.min(game.player.vz,30));
    game.player.rotY+=game.player.rotVel;
    game.player.rotVel*=0.9;
    game.player.vx*=0.95;
    game.player.rotVel=Math.max(-0.05,Math.min(game.player.rotVel,0.05));
    const moveX=Math.sin(game.player.rotY)*game.player.vz*0.016+game.player.vx*0.016;
    const moveZ=Math.cos(game.player.rotY)*game.player.vz*0.016;
    game.player.x+=moveX;game.player.z+=moveZ;
    game.player.vy-=0.6;game.player.y+=game.player.vy*0.016;

    // Terrain collision
    const nearest = game.terrain.reduce((a,b)=>Math.abs(b.z-game.player.z)<Math.abs(a.z-game.player.z)?b:a);
    if(game.player.y<=nearest.height+2){game.player.y=nearest.height+2;game.player.vy=0;game.player.onGround=true;}
    else game.player.onGround=false;

    // Check crash
    game.objects.forEach(o=>{
      const dx=o.x-game.player.x, dz=o.z-game.player.z;
      const dist=Math.sqrt(dx*dx+dz*dz);
      if(o.objType==='rock' && dist<o.radius+1.5 && game.player.onGround) game.crashed=true;
      if(o.objType==='log' && dist<2 && game.player.onGround) game.crashed=true;
      if(o.objType==='finish' && game.player.z>=o.z) game.finished=true;
    });

    // Render
    ctx.fillStyle=selectedMap.skyColor;ctx.fillRect(0,0,canvas.width,canvas.height);

    // Mountains
    ctx.fillStyle=shadeColor(selectedMap.groundColor,-40);
    ctx.globalAlpha=0.6;
    ctx.beginPath();
    for(let i=0;i<canvas.width;i+=30){const h=150+Math.sin(i*0.008+game.player.z*0.01)*80;if(i===0)ctx.moveTo(i,h);else ctx.lineTo(i,h);}
    ctx.lineTo(canvas.width,canvas.height);ctx.lineTo(0,canvas.height);ctx.closePath();ctx.fill();
    ctx.globalAlpha=1;

    // Terrain
    game.terrain.forEach(seg=>{
      const p1=project3D(seg.leftEdge,seg.height,seg.z);
      const p2=project3D(seg.rightEdge,seg.height,seg.z);
      if(!p1||!p2) return;
      ctx.fillStyle=selectedMap.groundColor;
      ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.lineTo(p2.x,canvas.height);ctx.lineTo(p1.x,canvas.height);ctx.closePath();ctx.fill();
    });

    // Objects
    game.objects.forEach(o=>{
      if(o.objType==='rock') drawCylinder(o.x,o.y,o.z,o.radius,o.radius*1.5,o.color);
      if(o.objType==='log') drawBox(o.x,o.y,o.z,o.width,o.width,o.length,o.color);
    });

    // Trees/bushes
    game.trees.forEach(t=>{
      drawCylinder(t.x,t.y,t.z,t.radius,t.height,t.isBush?'#2d5016':'#3d2817');
    });

    // HUD
    ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(10,10,280,90);
    ctx.fillStyle='#fff';ctx.font='18px Arial';
    ctx.fillText(`Distance: ${Math.floor(game.player.distance)}m / ${selectedTrail.length}m`,20,35);
    ctx.fillText(`Speed: ${Math.floor(game.player.vz*8)} km/h`,20,60);
    ctx.fillText(`Air: ${game.player.onGround?'NO':'YES'}`,20,85);

    // Crash/Finish overlay
    if(game.crashed){ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='red';ctx.font='60px Arial';ctx.fillText('CRASHED!',canvas.width/2-150,canvas.height/2-50);}
    if(game.finished){ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='lime';ctx.font='60px Arial';ctx.fillText('FINISHED!',canvas.width/2-150,canvas.height/2-50);}

    animationRef=requestAnimationFrame(loop);
  }
  loop();
}
</script>
</body>
</html>
