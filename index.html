<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mountain Bike 3D</title>
<style>
  html, body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; }
  canvas { display: block; background: linear-gradient(to top, #4CAF50, #87CEEB); }
  .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
  .menu, .bike-select, .map-select, .trail-select { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 600px; width: 90%; }
  .menu h1, .bike-select h2, .map-select h2, .trail-select h2 { text-align: center; }
  .grid { display: grid; gap: 12px; }
  .grid-2 { grid-template-columns: repeat(2, 1fr); }
  .grid-1 { grid-template-columns: 1fr; }
  button { padding: 12px; border-radius: 8px; border: 2px solid #888; background: #fff; cursor: pointer; font-weight: bold; }
  button:hover { border-color: #4CAF50; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div class="ui-overlay" id="uiOverlay">
  <div class="menu" id="menuScreen">
    <h1>Mountain Bike 3D</h1>
    <p style="text-align:center;">Ride the mountain trails in first person!</p>
    <button onclick="startBikeSelect()">Start Game</button>
  </div>

  <div class="bike-select" id="bikeSelectScreen" style="display:none;">
    <h2>Select Your Bike</h2>
    <div class="grid grid-2" id="bikeGrid"></div>
  </div>

  <div class="map-select" id="mapSelectScreen" style="display:none;">
    <h2>Select Your Mountain</h2>
    <div class="grid grid-1" id="mapGrid"></div>
    <button onclick="backToBikes()">Back to Bikes</button>
  </div>

  <div class="trail-select" id="trailSelectScreen" style="display:none;">
    <h2>Select a Trail</h2>
    <div class="grid grid-1" id="trailGrid"></div>
    <button onclick="backToMaps()">Back to Maps</button>
  </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let screen = 'menu';
let selectedBike = null;
let selectedMap = null;
let selectedTrail = null;
let animationRef = null;

// Key input
const keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// Bikes
const bikes = [
  { id:1, name:'Trail Blazer', color:'#FF0000', speed:1.0, handling:0.8, jump:0.7 },
  { id:2, name:'Mountain King', color:'#0000FF', speed:0.9, handling:1.0, jump:0.8 },
  { id:3, name:'Rock Rider', color:'#00FF00', speed:1.2, handling:0.7, jump:0.6 }
];

// Maps and trails
const maps = [
  { id:1, name:'Pine Hills', groundColor:'#8B4513', skyColor:'#87CEEB', dirtColor:'#A0522D', trails:[
    {id:1,name:'Easy Pine 1',length:500,difficulty:'easy',features:10},{id:2,name:'Easy Pine 2',length:550,difficulty:'easy',features:12},
    {id:3,name:'Medium Pine 1',length:600,difficulty:'medium',features:15},{id:4,name:'Medium Pine 2',length:650,difficulty:'medium',features:18},
    {id:5,name:'Hard Pine 1',length:700,difficulty:'hard',features:22},{id:6,name:'Hard Pine 2',length:750,difficulty:'hard',features:25}
  ]},
  { id:2, name:'Rocky Ridge', groundColor:'#A0522D', skyColor:'#87CEEB', dirtColor:'#D2691E', trails:[
    {id:1,name:'Easy Rock 1',length:500,difficulty:'easy',features:10},{id:2,name:'Easy Rock 2',length:550,difficulty:'easy',features:12},
    {id:3,name:'Medium Rock 1',length:600,difficulty:'medium',features:15},{id:4,name:'Medium Rock 2',length:650,difficulty:'medium',features:18},
    {id:5,name:'Hard Rock 1',length:700,difficulty:'hard',features:22},{id:6,name:'Hard Rock 2',length:750,difficulty:'hard',features:25}
  ]},
  { id:3, name:'Black Diamond Peaks', groundColor:'#2F4F4F', skyColor:'#4682B4', dirtColor:'#696969', trails:[
    {id:1,name:'Easy Peak 1',length:500,difficulty:'easy',features:10},{id:2,name:'Easy Peak 2',length:550,difficulty:'easy',features:12},
    {id:3,name:'Medium Peak 1',length:600,difficulty:'medium',features:15},{id:4,name:'Medium Peak 2',length:650,difficulty:'medium',features:18},
    {id:5,name:'Hard Peak 1',length:700,difficulty:'hard',features:22},{id:6,name:'Hard Peak 2',length:750,difficulty:'hard',features:25}
  ]}
];

function startBikeSelect() {
  document.getElementById('menuScreen').style.display='none';
  document.getElementById('bikeSelectScreen').style.display='block';
  const grid = document.getElementById('bikeGrid');
  grid.innerHTML = '';
  bikes.forEach(bike=>{
    const btn = document.createElement('button');
    btn.innerHTML = `<div style="width:32px;height:32px;background:${bike.color};border-radius:50%;margin:auto;"></div>
                     <div>${bike.name}</div>
                     <div>Speed: ${'⭐'.repeat(Math.ceil(bike.speed*3))}</div>
                     <div>Handling: ${'⭐'.repeat(Math.ceil(bike.handling*3))}</div>
                     <div>Jump: ${'⭐'.repeat(Math.ceil(bike.jump*3))}</div>`;
    btn.onclick = () => { selectedBike = bike; startMapSelect(); };
    grid.appendChild(btn);
  });
}

function startMapSelect() {
  document.getElementById('bikeSelectScreen').style.display='none';
  document.getElementById('mapSelectScreen').style.display='block';
  const grid = document.getElementById('mapGrid');
  grid.innerHTML = '';
  maps.forEach(map=>{
    const btn = document.createElement('button');
    btn.textContent = map.name;
    btn.onclick = () => { selectedMap = map; startTrailSelect(); };
    grid.appendChild(btn);
  });
}

function startTrailSelect() {
  document.getElementById('mapSelectScreen').style.display='none';
  document.getElementById('trailSelectScreen').style.display='block';
  const grid = document.getElementById('trailGrid');
  grid.innerHTML = '';
  selectedMap.trails.forEach(trail=>{
    const btn = document.createElement('button');
    btn.textContent = `${trail.name} • ${trail.length}m • ${trail.difficulty.toUpperCase()}`;
    btn.onclick = () => { selectedTrail = trail; startGame(); };
    grid.appendChild(btn);
  });
}

function backToBikes() {
  document.getElementById('mapSelectScreen').style.display='none';
  document.getElementById('bikeSelectScreen').style.display='block';
}

function backToMaps() {
  document.getElementById('trailSelectScreen').style.display='none';
  document.getElementById('mapSelectScreen').style.display='block';
}

// Game state
const game = {
  player:{x:0,y:0,z:0,vx:0,vy:0,vz:5,rotY:0,rotVel:0,onGround:true,distance:0},
  objects:[],
  terrain:[],
  crashed:false,
  finished:false,
  speed:0,
  time:0,
  mountainSides:[],
  trees:[]
};

// Initialize terrain, trees, obstacles for demo
function initLevel() {
  game.player.x = 0;
  game.player.z = 0;
  game.player.y = 2; // Start on ground
  game.player.vx = 0; game.player.vy=0; game.player.vz=5;
  game.crashed=false; game.finished=false; game.time=1;
  game.terrain = [];
  game.objects = [];
  game.mountainSides = [];
  game.trees = [];

  // Simple procedural trail
  for(let i=0;i<=selectedTrail.length;i+=5){
    game.terrain.push({centerX:0,height:0,z:i,leftEdge:-5,rightEdge:5,width:10});
  }
}

// Project 3D point to 2D
function project3D(x,y,z){
  const scale = 500/(z+50);
  return {x:canvas.width/2 + x*scale, y:canvas.height/2 - y*scale, scale:scale, depth:z};
}

// Draw simple cylinder for tree/bush
function drawCylinder(x,y,z,radius,height,color){
  const p = project3D(x,y,z);
  if(!p) return;
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.ellipse(p.x,p.y,radius*p.scale,height*p.scale,0,0,2*Math.PI);
  ctx.fill();
}

// Draw box for obstacles
function drawBox(x,y,z,w,h,d,color){
  const p = project3D(x,y,z);
  if(!p) return;
  ctx.fillStyle=color;
  ctx.fillRect(p.x-w*p.scale/2,p.y-h*p.scale/2,w*p.scale,h*p.scale);
}

function startGame() {
  document.getElementById('trailSelectScreen').style.display='none';
  document.getElementById('uiOverlay').style.display='none';
  initLevel();

  function gameLoop(){
    game.time += 0.016;

    // Controls
    const turnSpeed = 0.04;
    const jumpPower = 7 * selectedBike.jump;
    if(keys['ArrowLeft']||keys['a']||keys['A']){game.player.rotVel+=turnSpeed;game.player.vx+=0.08*selectedBike.handling;}
    if(keys['ArrowRight']||keys['d']||keys['D']){game.player.rotVel-=turnSpeed;game.player.vx-=0.08*selectedBike.handling;}
    if(keys[' '] && game.player.onGround){game.player.vy = jumpPower;game.player.onGround=false;}
    
    // Physics
    game.player.vz = Math.max(3, Math.min(game.player.vz*selectedBike.speed,30));
    game.player.rotY+=game.player.rotVel;
    game.player.rotVel*=0.90;
    game.player.vx*=0.95;
    game.player.rotVel=Math.max(-0.05,Math.min(game.player.rotVel,0.05));
    const moveX = Math.sin(game.player.rotY)*game.player.vz*0.016+game.player.vx*0.016;
    const moveZ = Math.cos(game.player.rotY)*game.player.vz*0.016;
    game.player.x+=moveX;
    game.player.z+=moveZ;
    game.player.vy-=0.6; // gravity
    game.player.y+=game.player.vy*0.016;

    // Terrain collision
    const terrainInfo = getTerrainAt(game.player.x,game.player.z);
    if(game.player.y<=terrainInfo.height+2){
      game.player.y = terrainInfo.height+2;
      if(game.player.vy<-12) game.crashed=true;
      game.player.vy=0;
      game.player.onGround=true;
    }else game.player.onGround=false;

    // Update distance and speed
    game.player.distance = game.player.z;
    game.speed = game.player.vz;

    // Render
    ctx.fillStyle=selectedMap.skyColor;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Terrain
    ctx.fillStyle=selectedMap.groundColor;
    game.terrain.forEach(seg=>{
      const p1=project3D(seg.leftEdge,seg.height,seg.z);
      const p2=project3D(seg.rightEdge,seg.height,seg.z);
      if(p1 && p2){
        ctx.beginPath();
        ctx.moveTo(p1.x,p1.y);
        ctx.lineTo(p2.x,p2.y);
        ctx.lineTo(p2.x,canvas.height);
        ctx.lineTo(p1.x,canvas.height);
        ctx.closePath();
        ctx.fill();
      }
    });

    // Draw bike HUD
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.fillRect(10,10,280,110);
    ctx.fillStyle='#FFF';
    ctx.font='bold 18px Arial';
    ctx.fillText(`Distance: ${Math.floor(game.player.distance)}m / ${selectedTrail.length}m`,20,35);
    ctx.fillText(`Speed: ${Math.floor(game.speed*8)} km/h`,20,60);
    ctx.fillText(`Time: ${game.time.toFixed(1)}s`,20,85);
    ctx.fillText(`Air: ${game.player.onGround?'NO':'YES'}`,20,110);

    if(game.crashed || game.player.z>=selectedTrail.length){ 
      ctx.fillStyle='rgba(0,0,0,0.8)'; 
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=game.crashed?'#FF0000':'#4CAF50';
      ctx.font='bold 60px Arial';
      ctx.fillText(game.crashed?'CRASHED!':'FINISHED!',canvas.width/2-150,canvas.height/2-40);
      ctx.fillStyle='#FFF';
      ctx.font='32px Arial';
      ctx.fillText(`Time: ${game.time.toFixed(2)}s`,canvas.width/2-90,canvas.height/2+20);
      ctx.font='28px Arial';
      ctx.fillText('Press R to retry',canvas.width/2-100,canvas.height/2+70);
      if(keys['r']||keys['R']) initLevel();
      animationRef=requestAnimationFrame(gameLoop);
      return;
    }

    animationRef=requestAnimationFrame(gameLoop);
  }
  gameLoop();
}

// Get terrain height at x,z
function getTerrainAt(x,z){
  let closest={height:0,onTrack:true};
  game.terrain.forEach(seg=>{
    if(Math.abs(seg.z-z)<5) closest.height=seg.height;
  });
  return closest;
}
</script>
</body>
</html>
