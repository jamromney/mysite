<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mountain Bike 3D</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    background: linear-gradient(to bottom, #4aa1f0, #3c7d1e);
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: transparent;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
// ------------------------- GAME SETUP -------------------------
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Game state
const game = {
    time: 0,
    player: {
        x: 0,
        y: 10,
        z: 0,
        vx: 0,
        vy: 0,
        vz: 5,
        rotY: 0,
        rotVel: 0,
        onGround: true,
        distance: 0
    },
    crashed: false,
    finished: false,
    speed: 0,
    objects: [],
    terrain: [],
    mountainSides: [],
    trees: []
};

// ------------------------- UTILITIES -------------------------
function shadeColor(color, percent) {
    const f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent;
    const R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
    return "#" + (0x1000000 + (Math.round((t-R)*p)+R)*0x10000 + (Math.round((t-G)*p)+G)*0x100 + (Math.round((t-B)*p)+B)).toString(16).slice(1);
}
function project3D(x,y,z) {
    const scale = 500 / (z - game.player.z + 500);
    const px = canvas.width/2 + (x - game.player.x) * scale;
    const py = canvas.height/2 - (y - game.player.y) * scale;
    return {x:px, y:py, depth:z};
}

// ------------------------- TERRAIN -------------------------
const trackLength = 1000;
for(let i=0;i<trackLength;i++){
    const height = Math.sin(i*0.05)*20;
    game.terrain.push({
        z:i*5,
        height: height,
        width: 20,
        leftEdge: -10,
        rightEdge: 10,
        centerX: 0
    });
}

// ------------------------- OBJECTS -------------------------
game.objects.push({type:'rock', x:2, y:0, z:100, radius:2, color:'#888'});
game.objects.push({type:'log', x:-3, y:0, z:200, width:2, length:6, color:'#552200'});
game.objects.push({type:'finish', x:0, y:0, z:trackLength*5, depth:2});

// ------------------------- TREES -------------------------
for(let i=50;i<trackLength*5;i+=50){
    const isBush = Math.random()<0.3;
    game.trees.push({
        x:(Math.random()-0.5)*30,
        y:0,
        z:i,
        radius: isBush?3:2,
        height: isBush?2:10,
        isBush: isBush
    });
}

// ------------------------- CONTROLS -------------------------
const keys = {};
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// ------------------------- RENDERING FUNCTIONS -------------------------
function drawCylinder(x, y, z, radius, height, color){
    const p = project3D(x,y,z);
    const ph = project3D(x,y+height,z);
    if(!p || !ph) return;
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.ellipse(p.x, p.y, radius*ph.depth/500, radius*ph.depth/500, 0, 0, Math.PI*2);
    ctx.fill();
}
function drawBox(x, y, z, w, h, d, color){
    const p = project3D(x, y, z);
    if(!p) return;
    ctx.fillStyle=color;
    const scale = 500/(z - game.player.z + 500);
    ctx.fillRect(p.x-w*scale/2, p.y-h*scale, w*scale, h*scale);
}

// ------------------------- GAME LOOP -------------------------
function gameLoop(){
    game.time += 0.016;
    if(!game.crashed && !game.finished){
        // --- Controls ---
        const turnSpeed = 0.02;
        const jumpPower = 12;
        if(keys['a'] || keys['A'] || keys['ArrowLeft']){ game.player.rotVel += turnSpeed; game.player.vx += 0.08; }
        if(keys['d'] || keys['D'] || keys['ArrowRight']){ game.player.rotVel -= turnSpeed; game.player.vx -= 0.08; }
        if(keys[' '] && game.player.onGround){ game.player.vy = jumpPower; game.player.onGround=false; }
        
        // --- Physics ---
        game.player.vz = Math.max(3, Math.min(game.player.vz,30));
        game.player.rotY += game.player.rotVel;
        game.player.rotVel *= 0.90;
        game.player.vx *= 0.95;
        game.player.rotVel = Math.max(-0.05, Math.min(game.player.rotVel,0.05));
        const moveX = Math.sin(game.player.rotY)*game.player.vz*0.016 + game.player.vx*0.016;
        const moveZ = Math.cos(game.player.rotY)*game.player.vz*0.016;
        game.player.x += moveX;
        game.player.z += moveZ;
        game.player.vy -= 0.6; // gravity
        game.player.y += game.player.vy*0.016;
        
        // Terrain collision
        const terrainInfo = game.terrain[Math.floor(game.player.z/5)] || {height:0};
        if(game.player.y <= terrainInfo.height + 2){
            game.player.y = terrainInfo.height + 2;
            if(game.player.vy < -12) game.crashed = true;
            game.player.vy=0;
            game.player.onGround = true;
        }else game.player.onGround=false;
        
        // Objects collision
        game.objects.forEach(obj=>{
            const dx = obj.x - game.player.x;
            const dz = obj.z - game.player.z;
            const dist = Math.sqrt(dx*dx + dz*dz);
            if(obj.type==='rock' && dist<obj.radius+1.5 && game.player.onGround) game.crashed=true;
            if(obj.type==='log' && dist<2 && game.player.onGround) game.crashed=true;
            if(obj.type==='finish' && game.player.z>=obj.z) game.finished=true;
        });
        game.player.distance = game.player.z;
        game.speed = game.player.vz;
    }
    
    // --- Rendering ---
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // Sky
    ctx.fillStyle='#4aa1f0';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Mountains
    ctx.fillStyle='#2d5016';
    ctx.globalAlpha=0.6;
    ctx.beginPath();
    for(let i=0;i<canvas.width;i+=30){
        const h = 150 + Math.sin(i*0.008 + game.player.z*0.01)*80;
        i===0?ctx.moveTo(i,h):ctx.lineTo(i,h);
    }
    ctx.lineTo(canvas.width,canvas.height);
    ctx.lineTo(0,canvas.height);
    ctx.closePath();
    ctx.fill();
    ctx.globalAlpha=1;
    
    // Terrain segments
    for(let i=0;i<game.terrain.length-1;i++){
        const seg = game.terrain[i];
        const next = game.terrain[i+1];
        const p1=project3D(seg.leftEdge,seg.height,seg.z);
        const p2=project3D(seg.rightEdge,seg.height,seg.z);
        const p3=project3D(next.rightEdge,next.height,next.z);
        const p4=project3D(next.leftEdge,next.height,next.z);
        if(p1 && p2 && p3 && p4){
            ctx.fillStyle='#7d5a3c';
            ctx.beginPath();
            ctx.moveTo(p1.x,p1.y);
            ctx.lineTo(p2.x,p2.y);
            ctx.lineTo(p3.x,p3.y);
            ctx.lineTo(p4.x,p4.y);
            ctx.closePath();
            ctx.fill();
        }
    }
    
    // Objects
    game.objects.forEach(obj=>{
        if(obj.type==='rock') drawCylinder(obj.x,obj.y,obj.z,obj.radius,2,obj.color);
        else if(obj.type==='log') drawBox(obj.x,obj.y,obj.z,obj.width,obj.width,obj.length,obj.color);
    });
    
    // UI
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillRect(10,10,200,80);
    ctx.fillStyle='#fff';
    ctx.font='bold 18px Arial';
    ctx.fillText(`Distance: ${Math.floor(game.player.distance)}m`, 20, 35);
    ctx.fillText(`Speed: ${Math.floor(game.speed*8)} km/h`, 20, 60);
    ctx.fillText(`Air: ${game.player.onGround?'NO':'YES'}`, 20, 85);
    
    if(game.crashed){
        ctx.fillStyle='rgba(0,0,0,0.7)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#ff0000';
        ctx.font='bold 60px Arial';
        ctx.fillText('CRASHED!',canvas.width/2-150,canvas.height/2-50);
    }
    if(game.finished){
        ctx.fillStyle='rgba(0,0,0,0.7)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#4CAF50';
        ctx.font='bold 60px Arial';
        ctx.fillText('FINISHED!',canvas.width/2-150,canvas.height/2-40);
    }
    
    requestAnimationFrame(gameLoop);
}

gameLoop();

// Resize
window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});
</script>
</body>
</html>
