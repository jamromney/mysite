<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mountain Bike 3D</title>
<style>
  body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
  #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
  .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: all; }
  button { cursor: pointer; margin: 5px; }
  .overlay { position: absolute; color: white; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; font-weight: bold; }
</style>
</head>
<body>
<div id="ui">
  <div id="startScreen" class="screen">
    <h1>Mountain Bike 3D</h1>
    <p>Ride the mountain trails in first-person view!</p>
    <button onclick="showScreen('bikeSelect')">Start Game</button>
  </div>

  <div id="bikeSelect" class="screen" style="display:none;">
    <h2>Select Your Bike</h2>
    <div id="bikeButtons"></div>
    <button onclick="showScreen('startScreen')">Back</button>
  </div>

  <div id="mapSelect" class="screen" style="display:none;">
    <h2>Select Map</h2>
    <div id="mapButtons"></div>
    <button onclick="showScreen('bikeSelect')">Back</button>
  </div>

  <div id="trailSelect" class="screen" style="display:none;">
    <h2>Select Trail</h2>
    <div id="trailButtons"></div>
    <button onclick="showScreen('mapSelect')">Back</button>
  </div>

  <div id="gameUI" style="display:none;">
    <div class="overlay" style="top:10px; left:10px;" id="stats"></div>
    <div class="overlay" style="top:10px; right:10px;" id="timer"></div>
  </div>

  <div id="messageScreen" class="screen" style="display:none;">
    <h1 id="messageTitle"></h1>
    <p id="messageText"></p>
    <button onclick="restartGame()">Retry</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>

<script>
let scene, camera, renderer, controls;
let player = { x:0, y:2, z:0, vx:0, vy:0, rotY:0, rotVel:0, onGround:true, distance:0 };
let keys = {};
let clock = new THREE.Clock();
let obstacles = [];
let trailMesh;
let trailLength = 200;
let crashed = false;
let finished = false;
let startTime = 0;

const bikes = [
  { id:1, name:"Speedster", color:"red", speed:3, handling:3, jump:2 },
  { id:2, name:"Trailblazer", color:"blue", speed:2, handling:4, jump:3 },
  { id:3, name:"Mountain King", color:"green", speed:3, handling:3, jump:3 }
];

const maps = [
  { id:1, name:"Alpine Peaks", trails:[{id:1,name:"Easy 1", difficulty:"green"}, {id:2,name:"Easy 2", difficulty:"green"}, {id:3,name:"Medium 1", difficulty:"blue"}, {id:4,name:"Medium 2", difficulty:"blue"}, {id:5,name:"Hard 1", difficulty:"black"}, {id:6,name:"Hard 2", difficulty:"black"}] },
  { id:2, name:"Forest Hills", trails:[{id:1,name:"Easy 1", difficulty:"green"}, {id:2,name:"Easy 2", difficulty:"green"}, {id:3,name:"Medium 1", difficulty:"blue"}, {id:4,name:"Medium 2", difficulty:"blue"}, {id:5,name:"Hard 1", difficulty:"black"}, {id:6,name:"Hard 2", difficulty:"black"}] },
  { id:3, name:"Rocky Ridge", trails:[{id:1,name:"Easy 1", difficulty:"green"}, {id:2,name:"Easy 2", difficulty:"green"}, {id:3,name:"Medium 1", difficulty:"blue"}, {id:4,name:"Medium 2", difficulty:"blue"}, {id:5,name:"Hard 1", difficulty:"black"}, {id:6,name:"Hard 2", difficulty:"black"}] }
];

let selectedBike = null;
let selectedMap = null;
let selectedTrail = null;

function showScreen(screenId){
  document.querySelectorAll('.screen').forEach(s => s.style.display='none');
  const screen = document.getElementById(screenId);
  if(screen) screen.style.display='flex';
}

function setupBikeSelect(){
  const container = document.getElementById('bikeButtons');
  container.innerHTML = '';
  bikes.forEach(bike=>{
    const btn = document.createElement('button');
    btn.textContent = bike.name + " " + "â­".repeat(Math.ceil(bike.speed));
    btn.onclick = ()=>{
      selectedBike = bike;
      showScreen('mapSelect');
      setupMapSelect();
    };
    container.appendChild(btn);
  });
}

function setupMapSelect(){
  const container = document.getElementById('mapButtons');
  container.innerHTML='';
  maps.forEach(map=>{
    const btn = document.createElement('button');
    btn.textContent = map.name;
    btn.onclick = ()=>{
      selectedMap = map;
      showScreen('trailSelect');
      setupTrailSelect();
    };
    container.appendChild(btn);
  });
}

function setupTrailSelect(){
  const container = document.getElementById('trailButtons');
  container.innerHTML='';
  selectedMap.trails.forEach(trail=>{
    const btn = document.createElement('button');
    btn.textContent = trail.name + " (" + trail.difficulty + ")";
    btn.onclick = ()=>{
      selectedTrail = trail;
      startGame();
    };
    container.appendChild(btn);
  });
}

function startGame(){
  showScreen('gameUI');
  initThree();
  spawnTrail();
  spawnObstacles();
  startTime = performance.now();
  animate();
}

function initThree(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(player.x, player.y+1.5, player.z);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff,0.4));

  controls = new THREE.PointerLockControls(camera, renderer.domElement);
  scene.add(controls.getObject());

  document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
  document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);
}

function spawnTrail(){
  const geometry = new THREE.PlaneGeometry(10, trailLength, 32,32);
  const material = new THREE.MeshPhongMaterial({color:0x8B4513});
  trailMesh = new THREE.Mesh(geometry, material);
  trailMesh.rotation.x = -Math.PI/2;
  trailMesh.position.z = trailLength/2;
  scene.add(trailMesh);

  // simple mountains
  const mountainGeom = new THREE.ConeGeometry(20,50,8);
  const mountainMat = new THREE.MeshPhongMaterial({color:0x555555});
  for(let i=0;i<5;i++){
    const m = new THREE.Mesh(mountainGeom, mountainMat);
    m.position.set(Math.random()*200-100,25,Math.random()*trailLength);
    scene.add(m);
  }
}

function spawnObstacles(){
  obstacles = [];
  for(let i=0;i<30;i++){
    const type = ['rock','log','bush'][Math.floor(Math.random()*3)];
    let obj;
    if(type==='rock'){
      const geom = new THREE.SphereGeometry(1+Math.random()*1.5,16,16);
      const mat = new THREE.MeshPhongMaterial({color:0x333333});
      obj = new THREE.Mesh(geom, mat);
    } else if(type==='log'){
      const geom = new THREE.CylinderGeometry(0.5,0.5,3,8);
      const mat = new THREE.MeshPhongMaterial({color:0x8B4513});
      obj = new THREE.Mesh(geom, mat);
      obj.rotation.z = Math.PI/2;
    } else if(type==='bush'){
      const geom = new THREE.SphereGeometry(1+Math.random()*1.5,8,8);
      const mat = new THREE.MeshPhongMaterial({color:0x2d5016});
      obj = new THREE.Mesh(geom, mat);
    }
    obj.position.set(Math.random()*6-3,0.5,Math.random()*trailLength);
    scene.add(obj);
    obstacles.push(obj);
  }
}

function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();

  if(!crashed && !finished){
    handleControls(dt);
    camera.position.set(player.x, player.y+1.5, player.z);
    player.distance = player.z;
    updateUI();
    checkCollisions();
    if(player.z >= trailLength){
      finished = true;
      showMessage('FINISHED!','You completed the trail!');
    }
  }

  renderer.render(scene,camera);
}

function handleControls(dt){
  const turnSpeed = 1.5;
  const jumpPower = 8;

  if(keys['arrowleft'] || keys['a']){ player.rotVel = turnSpeed*dt; }
  if(keys['arrowright'] || keys['d']){ player.rotVel = -turnSpeed*dt; }
  if(keys[' '] && player.onGround){ player.vy = jumpPower; player.onGround=false; }

  player.rotY += player.rotVel;
  player.rotVel *= 0.9;

  player.vz = 10; // constant forward
  player.vx = 0;

  const moveX = Math.sin(player.rotY) * player.vz * dt;
  const moveZ = Math.cos(player.rotY) * player.vz * dt;
  player.x += moveX;
  player.z += moveZ;

  player.vy -= 20*dt; // gravity
  player.y += player.vy*dt;

  if(player.y<=1){
    player.y = 1;
    player.vy=0;
    player.onGround=true;
  } else player.onGround=false;

  if(keys['r'] && (crashed||finished)){ restartGame(); }
}

function checkCollisions(){
  for(const obj of obstacles){
    const dx = obj.position.x - player.x;
    const dz = obj.position.z - player.z;
    const dist = Math.sqrt(dx*dx+dz*dz);
    if(dist<1.5){ // simple radius check
      crashed = true;
      showMessage('CRASHED!','You hit an obstacle!');
    }
  }
}

function showMessage(title,text){
  document.getElementById('messageTitle').textContent=title;
  document.getElementById('messageText').textContent=text;
  showScreen('messageScreen');
}

function restartGame(){
  crashed=false;
  finished=false;
  player = { x:0, y:2, z:0, vx:0, vy:0, rotY:0, rotVel:0, onGround:true, distance:0 };
  showScreen('gameUI');
}

function updateUI(){
  document.getElementById('stats').innerHTML=`Distance: ${player.distance.toFixed(1)}m`;
  document.getElementById('timer').innerHTML=`Time: ${((performance.now()-startTime)/1000).toFixed(2)}s`;
}

// Initialize
setupBikeSelect();
</script>
</body>
</html>
